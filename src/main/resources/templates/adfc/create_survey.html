<html layout:decorate="~{layout/layout}" xmlns:th="http://thymeleaf.org">

<head>
  <title>ADFC - Umfrage erstellen</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  crossorigin="" type="text/javascript"></script>

  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

</head>

<body layout:fragment="content">

  <div id="createSurveyApp">

    <h2 class="my-4">Umfrage erstellen</h2>
    <div class="mb-4" id="mapid" style="width: calc(90vw - 8rem); height: 30vh;"></div>
    <div class="card">
      <div class="card-body">
        <form @submit="postSurvey">
          <div class="row">
            <div class="col border-right">
              <!-- common infos -->
              <div class="form-group">
                <label>Titel</label>
                <input class="form-control" v-model="title" placeholder="Titel"></input>
              </div>

              <div class="form-group">
                <label>Zeitfenster</label>
                <input type="date" class="form-control mb-2" placeholder="From" v-model="dateFrom">
                <input type="date" class="form-control mb-2" placeholder="To" v-model="dateTo">
              </div>

              <div class="form-group">
                <label>Anzahl an Bestätigungen benötigt:</label>
                <input type="number" class="form-control" :placeholder="confirmedThreshhold"
                v-model="confirmedThreshhold">
              </div>

              <div class="form-group">
                <!-- category -->
                <label>Kategorie</label>
                <input class="form-control" v-model="category" placeholder="Kategorie"></input>
              </div>

            </div>

            <div class="col">
              <!-- question -->
              <div v-for="(question, index) in questions">

                <!-- toogle <hr> after first question -->
                <div v-if="questions.indexOf(question) > 0">
                  <hr>
                </div>

                <div class="form-group">
                  <label>Frage #{{ index + 1 }}</label>
                  <input class="form-control" v-model="question.title" placeholder="Frage"></input>
                </div>

                <div class="form-group">
                  <label>Antwortmöglichkeiten</label>
                  <div v-for="answer in question.answers" class="mb-4">
                    <input class="form-control" v-model="answer.text">
                  </div>
                  <div class="button-group">
                    <!-- add answer -->
                    <button type="button" class="btn btn-primary mb-3" @click="addAnswer(question)"><i
                      class="fas fa-plus"></i></button>
                      <!-- delete answer -->
                      <button type="button" class="btn btn-danger mb-3" @click="removeAnswer(question)"><i
                        class="fas fa-minus"></i></button>
                      </div>

                    </div>

                    <div class="form-group" v-for="(condition, index) in question.conditions">
                      <label :for="'condition-question' + index">Bedingung: Frage nur zeigen wenn:</label>
                      <select :id="'condition-question' + index" v-model="condition.question">
                        <option default disabled>-</option>
                        <option v-for="question in questions" :value="question">{{ question.title }}</option>
                      </select>
                      <label for="'condition-answer' + index">mit:</label>
                      <select id="'condition-answer' + index" v-if="condition.question" v-model="condition.expectedAnswer">
                        <option v-for="answer in condition.question.answers" :value="answer">{{ answer.text }}</option>
                      </select>
                      <label>beantwortet wurde.</label>
                    </div>

                    <div class="button-group">
                      <!-- add condition -->
                      <button type="button" class="btn btn-primary mb-3" @click="addCondition(question)">Bedingung
                      hinzufügen</button>
                      <!-- delete condition -->
                      <button type="button" class="btn btn-danger mb-3" @click="deleteCondition(question)">Bedingung
                      löschen</button>
                    </div>

                    <div class="form-group">
                      <!-- delete question -->
                      <button type="button" class="btn btn-danger mb-3" @click="deleteQuestion(question)">Frage
                      löschen</button>
                    </div>

                  </div>

                  <hr>

                  <div class="form-group">
                    <!-- add question -->
                    <button type="button" class="btn btn-primary mb-3" @click="addQuestion">Frage hinzufügen</button>
                  </div>

                </div>
              </div>

              <!-- create survey -->
              <div class="form-group">
                <button type="submit" class="btn btn-primary">Umfrage erstellen</button>
              </div>

            </form>

          </div>
        </div>
      </div>

      <script type="text/javascript">

        const createSurveyApp = new Vue({
          el: '#createSurveyApp',
          data: {
            title: '',
            category: '',
            dateFrom: null,
            dateTo: null,
            confirmedThreshhold: 10,
            questions: [],
            creator: '',
            createdManually: true,

        // store coordinates coming from controller
        lat: [[${ lat }]],
        lng: [[${ lng }]],
        markers: null,
        mymap: null,

      },
      mounted() {
        // initially add first question
        this.addQuestion()

        // init popup
        var popup = L.popup();
        // init layerGroup holding all the markers
        // this is used to delete previous markers when clicking on map
        this.markers = L.layerGroup()

        // set map depending on whether real coordinates where given
        // default is somewhat the center of hamburg
        if (this.lat == 0 && this.lng == 0) {
          this.mymap = L.map('mapid').setView([53.551086, 9.993682], 12);

        } else {
          this.mymap = L.map('mapid').setView([this.lat, this.lng], 16);
          // add initial marker to map. this is duplicate code but vue does not let me use a function
          var marker = L.marker([this.lat, this.lng]).addTo(this.mymap)
          .bindPopup("<b>Hier wird die erstellte Umfrage sein.</b><br/>");
          this.markers.eachLayer((layer) => {
            layer.remove()
            self.markers.removeLayer(layer);
          });
          this.markers.addLayer(marker);

        }

        // init map
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
          maxZoom: 18,
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
          '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
          id: 'mapbox/streets-v11',
          tileSize: 512,
          zoomOffset: -1
        }).addTo(this.mymap);

        const self = this

        this.mymap.on('click', function (e) {
          const lat = e.latlng.lat
          const lng = e.latlng.lng

          // add marker to map, delete old one
          var marker = L.marker([lat, lng]).addTo(self.mymap)
          .bindPopup("<b>Hier wird die erstellte Umfrage sein.</b><br/>");
          self.markers.eachLayer((layer) => {
            layer.remove()
            self.markers.removeLayer(layer);
          });
          self.markers.addLayer(marker);
        })
      },
      created() {
      },
      methods: {
        addQuestion() {
          this.questions.push({
            title: '',
            answers: [
            { text: 'Ja', },
            { text: 'Nein', },
            ],
            conditions: []
          })
        },
        //deletes a question
        deleteQuestion(question) {
          var index = this.questions.indexOf(question)
          console.log(index)
          this.questions.splice(index, 1)
        },
        //add answer
        addAnswer(question) {
          question.answers.push({ text: '' })
        },
        //delete latest answer in question.answers
        removeAnswer(question) {
          question.answers.pop()
        },
        //add condition
        addCondition(question) {
          question.conditions.push({
            question: null,
            expectedAnswer: null,
          })
        },
        //delete condition
        deleteCondition(question) {
          question.conditions.pop()
        },
        postSurvey(e) {
          e.preventDefault()
          // make post to controller with json data of survey

          // data object holding information
          const data = {};
          // creating unique id
          data.id = Math.floor(Math.random() * (100000 - 0 + 1)) + 0;

          // get data
          data.title = this.title;
          data.dateFrom = this.dateFrom;
          data.dateTo = this.dateTo;
          data.confirmedThreshhold = this.confirmedThreshhold
          data.questions = this.questions;
          data.category = this.category;
          data.confirmedByUsers = [];
          data.createdManually = this.createdManually;
          data.creator = this.creator;

          // get date
          // generate a timestamp
          var timestamp = Number(new Date())
          var date = new Date(timestamp)
          data.createdAtDate = date;

          // get coordinates of current marker
          // only one marker in layergroup, forEach only runs once
          this.markers.eachLayer(function (layer) {
            data.lat = layer.getLatLng().lat;
            data.lng = layer.getLatLng().lng;
          });

          // building and sending json
          const jsonString = JSON.stringify(data);
          const request = new XMLHttpRequest();
          request.open("POST", "/umfrage-erstellen");
          request.setRequestHeader("Content-Type", "application/json");
          request.send(jsonString);
        },
        addCreator(creator) {
        	this.creator = creator;
        },
      },
    })

  </script>
  
</body>

</html>