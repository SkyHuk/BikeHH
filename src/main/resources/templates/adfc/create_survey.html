<html layout:decorate="~{layout/layout}" xmlns:th="http://thymeleaf.org">
<head>
  <title>ADFC - Umfrage erstellen</title>

  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin="" type="text/javascript"></script>

  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

</head>
<body layout:fragment="content">

  <div id="createSurveyApp">

    <h2 class="my-4">Umfrage erstellen</h2>
    <div class="mb-4" id="mapid" style="width: calc(100vw - 3rem); height: 30vh;"></div>
    <div class="card">
      <div class="card-body">
        <form @submit="postSurvey">
          <div class="row">
            <div class="col border-right">

              <div class="form-group">
                <label>Titel</label>
                <input class="form-control" v-model="title" placeholder="Titel"></input>
              </div>

              <div class="form-group">
                <label>Zeitfenster</label>
                <input type="date" class="form-control mb-2" placeholder="From" v-model="dateFrom">
                <input type="date" class="form-control mb-2" placeholder="To" v-model="dateTo">
              </div>

              <div class="form-group">
                <label>Anzahl an Bestätigungen benötigt:</label>
                <input type="number" class="form-control" :placeholder="confirmedThreshhold" v-model="confirmedThreshhold">
              </div>

              <hr>

              <div class="form-group" v-for="(condition, index) in conditions">
                <label :for="'condition-question' + index">Bedingung: Frage nur zeigen wenn:</label>
                <select :id="'condition-question' + index" v-model="condition.question">
                  <option default disabled>-</option>
                  <option v-for="question in questions" :value="question">{{ question.title }}</option>
                </select>
                <label for="'condition-answer' + index">mit:</label>
                <select id="'condition-answer' + index" v-if="condition.question" v-model="condition.expectedAnswer">
                  <option v-for="answer in condition.question.answers" :value="answer">{{ answer.text }}</option>
                </select>
                <label>beantwortet wurde.</label>
              </div>

              <div class="form-group">
                <button type="button" class="btn btn-primary mb-3" @click="addCondition()">Bedingung hinzufügen</button>
              </div>

            </div>

            <div class="col">

              <div v-for="(question, index) in questions">
                <div class="form-group">
                  <label>Frage #{{ index + 1 }}</label>
                  <input class="form-control" v-model="question.title" placeholder="Frage"></input>
                </div>

                <div class="form-group">
                  <label>Antwortmöglichkeiten</label>
                  <div v-for="answer in question.answers" class="mb-4">
                    <input class="form-control" v-model="answer.text">
                  </div>
                  <button type="button" class="btn btn-primary mb-3" @click="addAnswer(question)"><i class="fas fa-plus"></i></button>
                </div>

                <hr>

              </div>

              <div class="form-group">
                <button type="button" class="btn btn-primary mb-3" @click="addQuestion">Frage hinzufügen</button>
              </div>

            </div>
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-primary">Umfrage erstellen</button>
          </div>

        </form>

      </div>
    </div>
  </div>

  <script type="text/javascript">

    const createSurveyApp = new Vue({
      el: '#createSurveyApp',
      data: {
        title: '',
        dateFrom: null,
        dateTo: null,
        confirmedThreshhold: 10,
        questions: [],
        conditions: [],

        // store coordinates coming from controller
        lat: [[${lat}]],
        lng: [[${lng}]],
        markers: null,
        mymap: null,

      },
      created() {
        // initially add first question
        this.addQuestion()

        // init popup
        var popup = L.popup();
        // init layerGroup holding all the markers
        // this is used to delete previous markers when clicking on map
        this.markers = L.layerGroup()

        // set map depending on whether real coordinates where given
        // default is somewhat the center of hamburg
        if (this.lat == 0 && this.lng ==0) {
          this.mymap = L.map('mapid').setView([53.551086, 9.993682], 12);
        } else {
          this.mymap = L.map('mapid').setView([this.lat, this.lng], 16);
          this.addMarkerToMap(this.lat, this.lng);
        }

        // init map
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
          maxZoom: 18,
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
          id: 'mapbox/streets-v11',
          tileSize: 512,
          zoomOffset: -1
        }).addTo(this.mymap);

        this.mymap.on('click', this.onMapClick);


      },
      methods: {
        addQuestion() {
          this.questions.push({
            title: '',
            answers: [
              { text: 'Ja', },
              { text: 'Nein', },
            ],
          })

        },
        addAnswer(question) {
          question.answers.push({ text: '' })

        },
        addCondition() {
          this.conditions.push({
            question: null,
            expectedAnswer: null,
          })

        },
        postSurvey(e) {
          e.preventDefault()
          // make post to controller with json data of survey

          // data object holding information
          const data = {};
          // crreating unique id
          data.id = Math.floor(Math.random() * (100000 - 0 + 1)) + 0;
          data.title = this.title;
          data.dateFrom = this.dateFrom;
          data.dateTo = this.dateTo;
          data.confirmedThreshhold = this.confirmedThreshhold

          // get coordinates of current marker
          // only one marker in layergroup, forEach only runs once
          this.markers.eachLayer(function(layer) {
            data.lat = layer.getLatLng().lat;
            data.lng = layer.getLatLng().lng;
          });

          // TODO: fill this
          // data.type = this.type

          data.questions = this.questions;
          // building and sending json
          const jsonString = JSON.stringify(data);
          const request = new XMLHttpRequest();
          request.open("POST", "/umfrage-erstellen");
          request.setRequestHeader("Content-Type", "application/json");
          request.send(jsonString);


        },
      },
      addMarkerToMap(lat, lng) {
        // add marker to map, delete old one
        var marker = L.marker([lat, lng]).addTo(this.mymap)
          .bindPopup("<b>Hier wird die erstellte Umfrage sein.<br/>");
        this.markers.eachLayer(function(layer) {
          layer.remove()
          this.markers.removeLayer(layer);
        });
        this.markers.addLayer(marker);
      },
      onMapClick(e) {
        // on click handler
        this.addMarkerToMap(e.latlng.lat, e.latlng.lng);
      },

    })

  </script>
</body>
</html>
